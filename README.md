# –ú–∏–Ω–∏-CRM API

–ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π backend‚Äë—Å–µ—Ä–≤–∏—Å —É—Ä–æ–≤–Ω—è senior: FastAPI + SQLAlchemy 2.0 (async), JWT, —Ä–æ–ª–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, Docker.

---
## üì¶ –°—Ç–µ–∫

- **Python 3.11**
- **FastAPI** + **Pydantic v2**
- **SQLAlchemy 2.0 async** + **Alembic**
- **PostgreSQL** (–æ—Å–Ω–æ–≤–Ω–æ–π) / SQLite (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- **JWT** (`python-jose`, `passlib`)
- **pytest**, `pytest-asyncio`, `httpx`
- **mypy**, **ruff**
- **Docker / docker-compose**

---
## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
python -m venv venv
source venv/bin/activate   # Windows: venv\Scripts\activate
pip install -e .
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ `.env` (—Ñ–∞–π–ª –≤ `.gitignore`). –ü—Ä–∏–º–µ—Ä:

```
APP_NAME=MiniCRM
API_V1_PREFIX=/api/v1
SECRET_KEY=your_super_secret_key
DATABASE_URL=postgresql+asyncpg://crm:crm@localhost:5432/mini_crm
ENVIRONMENT=local
LOG_LEVEL=INFO
```

> –ï—Å–ª–∏ `.env` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Ç–µ—Å—Ç—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ SQLite (`sqlite+aiosqlite:///./mini_crm.db`).

### 3. –ú–∏–≥—Ä–∞—Ü–∏–∏

```bash
alembic upgrade head
```

### 4. –ó–∞–ø—É—Å–∫ API

```bash
uvicorn app.main:app --reload
```

API –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:8000`  
Swagger UI: `http://localhost:8000/docs`

---
## üê≥ –ó–∞–ø—É—Å–∫ –≤ Docker

```
docker compose up --build
```

–°–µ—Ä–≤–∏—Å—ã:
- `db` ‚Äî PostgreSQL, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ volume `pgdata`.
- `app` ‚Äî —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞, –æ–∂–∏–¥–∞–Ω–∏–µ –ë–î, –º–∏–≥—Ä–∞—Ü–∏–∏ `alembic upgrade head` –∏ –∑–∞–ø—É—Å–∫ Uvicorn.

Compose –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ `.env`, —á—Ç–æ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –¥–æ `docker compose up`).

---
## ‚úÖ –¢–µ—Å—Ç—ã –∏ –ª–∏–Ω—Ç–µ—Ä—ã

```bash
pytest
mypy app
ruff check app
```

> –í `pyproject.toml` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã `mypy`, `ruff`, `pytest`.

---
## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
.
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/              # —Ä–æ—É—Ç—ã + –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ core/             # –∫–æ–Ω—Ñ–∏–≥, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∫—ç—à
‚îÇ   ‚îú‚îÄ‚îÄ db/               # –±–∞–∑–∞, —Å–µ—Å—Å–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ models/           # ORM-–º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ repositories/     # —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º
‚îÇ   ‚îú‚îÄ‚îÄ services/         # –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ dependencies/     # –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã DI
‚îÇ   ‚îî‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ alembic/              # –º–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ docker/               # entrypoint –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ pyproject.toml
‚îî‚îÄ‚îÄ tests/                # unit + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```

---
## üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

1. `POST /api/v1/auth/login` ‚Äî –ø–µ—Ä–µ–¥–∞–π—Ç–µ JSON:
   ```json
   {"email": "owner@example.com", "password": "StrongPassword123"}
   ```
2. –ü–æ–ª—É—á–µ–Ω–Ω—ã–π `access_token` –≤—Å—Ç–∞–≤—å—Ç–µ –≤ Swagger:
   - –ù–∞–∂–º–∏—Ç–µ **Authorize**
   - –í –ø–æ–ª–µ `Value` —É–∫–∞–∂–∏—Ç–µ `Bearer <token>`
3. –ó–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å `Authorization: Bearer ...`

---
## üß© –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ú—É–ª—å—Ç–∏-–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, —Ä–æ–ª–∏: `owner / admin / manager / member`
- –ö–æ–Ω—Ç–∞–∫—Ç—ã, —Å–¥–µ–ª–∫–∏, –∑–∞–¥–∞—á–∏, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –¢–∞–π–º–ª–∞–π–Ω Activity + –∞–≤—Ç–æ—Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞/—Å—Ç–∞–¥–∏–∏
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (summary, funnel) —Å TTL-–∫—ç—à–µ–º
- –ñ—ë—Å—Ç–∫–∏–µ –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ (amount>0 –¥–ª—è won, –∑–∞–ø—Ä–µ—Ç –æ—Ç–∫–∞—Ç–∞ —Å—Ç–∞–¥–∏–π –∏ —Ç.–¥.)
- JWT access/refresh —Ç–æ–∫–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π, `X-Organization-Id`
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic (–≤ Docker –∂–¥—É—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î)

---
## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `tests/test_full_flow.py` –µ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π:
1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
2. –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –∫–æ–Ω—Ç–∞–∫—Ç–∞, —Å–¥–µ–ª–∫–∏
3. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

–ü–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–ª—é—á–µ–≤–æ–π happy-path.

---
## üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|---------|
| `alembic revision --autogenerate -m "msg"` | –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è |
| `alembic upgrade head` | –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ |
| `pytest -q` | —Ç–µ—Å—Ç—ã |
| `uvicorn app.main:app --reload` | –¥–µ–≤-—Å–µ—Ä–≤–µ—Ä |
| `docker compose up --build` | –∑–∞–ø—É—Å–∫ –≤—Å–µ–≥–æ —Å—Ç–µ–∫–∞ |



